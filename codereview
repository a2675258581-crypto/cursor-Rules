# codereview

Write your command content here.

This command will be available in chat with /codereview

仅审查本次提交的改动（优先 git diff --staged）。
请对以下Java代码进行全面的代码审查，特别注意：

1. **编译与语法检查**：
    - 所有语法错误和编译问题
    - 导入缺失的包或类
    - 类型不匹配和转型问题

2. **基础逻辑错误**：
    - 定义了但从未使用的变量、方法或类
    - 变量在不合理场景被重复使用（如覆盖重要数据）
    - 错误的循环条件或递归终止条件
    - 方法返回值被忽略

3. **逻辑漏洞检测**：
    - 死循环或无限递归风险
    - 潜在的竞态条件和死锁
    - 空指针引用（NPE）风险点
    - 数组/集合越界访问
    - 并发修改异常（ConcurrentModificationException）
    - 资源泄露（未关闭的流、连接等）

4. **异常处理审查**：
    - try-catch块是否"吃掉"异常（catch后不处理、不记录）
    - 是否抛出了过于宽泛的异常
    - 异常信息是否足够详细
    - finally块中的资源清理

5. **依赖与启动检查**：
    - 新引入的依赖是否会导致版本冲突
    - Bean注入问题（如循环依赖、缺少@Component注解）
    - 配置属性缺失或错误
    - Spring Bean生命周期问题

6. **支付类业务特别检查**：
    - 绝对不能出现重复支付漏洞
    - 不能出现支付错误，漏支付的问题

7. **sql语法问题**：
    - 如果存在原生sql的写法，需要自动检测是mysql还是oracle，并自己判断执行版本,并且通过cursor的mcp服务，去对应oracle或者mysql的mcp服务下判断是否存在语法问题
    - 结合表的索引和表结构给出原生sql的优化建议
    - 如果工程使用的是mybatis 也要同步检测代码是否符合mybatis的语法

请特别关注以下可能导致BUG的模式：

1. **边界条件BUG**：
    - 集合为空时的处理
    - 数值计算溢出（特别是int/long转换）
    - 日期时间处理的时区问题
    - 浮点数精度比较问题

2. **并发BUG**：
    - 非线程安全的集合在并发环境使用
    - volatile/synchronized使用不当
    - 双重检查锁定的正确性
    - 线程池配置问题

3. **状态一致性BUG**：
    - equals()和hashCode()不匹配
    - 可变对象作为HashMap键
    - 对象状态在多方法调用间不一致

4. **序列化BUG**：
    - transient字段处理不当
    - 序列化版本UID缺失
    - 反序列化时的安全性问题

5. **资源管理BUG**：
    - 文件句柄泄露
    - 数据库连接未正确关闭
    - 锁未正确释放

请提供以下性能优化建议：
3. **I/O操作优化**：
    - 频繁的文件/网络操作批量化建议
    - 缓冲区大小优化
    - 异步处理建议

4. **数据库操作优化**：
    - N+1查询问题
    - 索引使用建议
    - 批量操作建议
    - 连接池配置建议

5. **并发性能优化**：
    - 锁粒度优化建议
    - 线程池参数调优建议
    - 避免过度同步

请按以下格式组织审查结果：

### 1. 编译与基础问题
- [ ] 问题描述（行号：具体问题）
- [ ] 建议修复方案

### 2. 逻辑漏洞与BUG
- [ ] BUG类型：具体问题描述（行号）
- [ ] 风险等级：高/中/低
- [ ] 修复建议

### 3. 性能优化建议
- [ ] 问题点描述（行号）
- [ ] 性能影响：轻微/中等/严重
- [ ] 优化方案

### 4. 代码质量建议
- [ ] 改进点描述（行号）
- [ ] 改进优先级：高/中/低
- [ ] 具体改进建议

### 5. 依赖与集成问题
- [ ] 问题描述
- [ ] 影响范围：局部/全局
- [ ] 解决方案

### 6. 紧急修复建议（如有）
- [ ] 必须立即修复的问题列表
- [ ] 修复截止建议
  对于以下特殊场景，请特别关注：

1. **微服务间调用**：
    - 超时配置是否合理
    - 熔断降级策略是否完备
    - 重试机制的幂等性

2. **数据库事务**：
    - 事务传播行为是否正确
    - 事务范围是否过大导致锁竞争
    - @Transactional使用是否正确

3. **缓存使用**：
    - 缓存击穿/穿透/雪崩防护
    - 缓存一致性保证
    - 缓存key设计合理性

4. **消息队列**：
    - 消息丢失防护
    - 消息重复消费处理
    - 死信队列配置

5. **分布式场景**：
    - 分布式锁的正确使用
    - 全局ID生成策略
    - 数据一致性方案

请按以下优先级顺序审查：

P0（阻塞级）：编译错误、启动失败、严重内存泄露、死锁、原生sql语法问题
P1（严重）：空指针风险、资源泄露、数据不一致、安全漏洞
P2（重要）：性能瓶颈、代码重复、异常处理不当
P3（建议）：代码可读性、小规模重构、注释完善
